<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D æ‰‹åŠ¿ç²’å­äº¤äº’</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš›ï¸</text></svg>">
    
    <style>
        :root {
            --primary-color: #ff00cc; /* é»˜è®¤ç²‰è‰² */
            --glass-bg: rgba(20, 20, 30, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }

        #video-container {
            display: none;
        }

        #ui-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 300px; 
            padding: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            z-index: 100;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        #ui-panel.hidden {
            transform: translateX(calc(-100% - 30px));
            opacity: 0;
        }

        h1 {
            font-size: 18px;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 10px rgba(255, 0, 204, 0.3);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #ff4444;
            border-radius: 50%;
            box-shadow: 0 0 8px #ff4444;
            transition: all 0.3s;
        }
        .status-dot.active {
            background: var(--primary-color);
            box-shadow: 0 0 12px var(--primary-color), 0 0 20px var(--primary-color);
        }
        .status-dot.exploding {
            background: #ffffff;
            box-shadow: 0 0 15px #ffffff, 0 0 30px #ffffff;
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 12px;
            color: #aaa;
            margin-bottom: 8px;
        }

        .shape-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .color-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-start;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .color-option.active {
            border-color: white;
            box-shadow: 0 0 10px white, 0 0 15px currentColor;
        }

        button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-color);
        }

        button.active {
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 0, 204, 0.4);
        }
        
        #top-right-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }

        .control-button {
            background: var(--glass-bg);
            backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--primary-color);
            font-size: 24px;
            z-index: 200;
            pointer-events: none;
            text-shadow: 0 0 10px rgba(255, 0, 204, 0.5);
            text-align: center;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--primary-color);
            font-size: 24px;
            z-index: 200;
            pointer-events: none;
            text-shadow: 0 0 10px rgba(255, 0, 204, 0.5);
            text-align: center;
        }

        /* ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿™é‡Œæ˜¯å¿…é¡»è¡¥ä¸Šçš„å…³é”®ä»£ç  ğŸ‘‡ğŸ‘‡ğŸ‘‡ */
        /* é™åˆ¶é«˜åº¦å¹¶å¼€å¯æ»šåŠ¨ï¼Œæ²¡æœ‰è¿™ä¸€æ®µï¼Œæ»šåŠ¨æ¡å‡ºä¸æ¥ */
        #image-model-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* ä¸¤åˆ—å¸ƒå±€ */
            gap: 8px;
            margin-bottom: 15px;
            
            /* å…³é”®é™åˆ¶ */
            max-height: 200px;       /* è¶…è¿‡ 200px é«˜åº¦å°±å¼€å§‹æ»šåŠ¨ */
            overflow-y: auto;        /* å¼€å¯å‚ç›´æ»šåŠ¨ */
            padding-right: 5px;      /* é˜²æ­¢æ»šåŠ¨æ¡é®æŒ¡æ–‡å­— */
            align-content: start;
        }
        /* ğŸ‘†ğŸ‘†ğŸ‘† è¡¥ä¸Šè¿™ä¸€æ®µ ğŸ‘†ğŸ‘†ğŸ‘† */

        /* --- æ»šåŠ¨æ¡ç¾åŒ– (ä½ åˆšæ‰å‘çš„è¿™éƒ¨åˆ†æ˜¯å¯¹çš„) --- */
        #image-model-container::-webkit-scrollbar {
            width: 6px; 
        }

        #image-model-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05); 
            border-radius: 3px;
        }

        #image-model-container::-webkit-scrollbar-thumb {
            background: rgba(255, 0, 204, 0.3); 
            border-radius: 3px;
            transition: background 0.3s;
        }

        #image-model-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 0, 204, 0.8); 
        }
    </style>
    
    <script src="https://unpkg.com/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <!-- ğŸŒŸ è¯·åœ¨è¿™é‡Œå¼•å…¥ä½  Python ç”Ÿæˆçš„æ–‡ä»¶ (ä¾‹å¦‚ new_model_data.js) -->
    <!-- å¦‚æœä½ æœ‰æ—§çš„ data æ–‡ä»¶ï¼Œå¯ä»¥æ³¨é‡Šæ‰ -->
    
    <script src="./models/fufu_001_data.js"></script>
    <script src="./models/fufu_002_data.js"></script>
    <script src="./models/fufu_003_data.js"></script>
    <script src="./models/fufu_004_data.js"></script>
    <script src="./models/fufu_005_data.js"></script>
    <script src="./models/fufu_006_data.js"></script>
    <script src="./models/fufu_007_data.js"></script>
    <script src="./models/fufu_008_data.js"></script>
    <script src="./models/fufu_009_data.js"></script>
    <script src="./models/fufu_010_data.js"></script>
    <script src="./models/fufu_011_data.js"></script>
    <script src="./models/fufu_012_data.js"></script>
    <script src="./models/fufu_013_data.js"></script>
</head>
<body>

    <div id="loading">
        æ­£åœ¨åŠ è½½è§†è§‰æ¨¡å‹...<br>
        <span style="font-size: 14px; color: #aaa;">è¯·å…è®¸æ‘„åƒå¤´æƒé™</span>
    </div>

    <div id="video-container">
        <video class="input_video"></video>
    </div>

    <div id="top-right-controls">
        <button id="toggle-ui-btn" class="control-button" title="éšè—/æ˜¾ç¤ºæ§åˆ¶é¢æ¿">â–</button>
        <button id="fullscreen-btn" class="control-button" title="å…¨å±æ¨¡å¼">â›¶</button>
    </div>
    
    <div id="ui-panel">
        <h1>
            <div class="status-dot" id="status-dot"></div>
            ç²’å­æ§åˆ¶å™¨
        </h1>
        
        <div class="control-group">
            <label>å½¢çŠ¶æ¨¡ç‰ˆ</label>
            <div class="shape-grid">
                <button class="shape-btn active" data-shape="heart">â¤ çˆ±å¿ƒ</button>
                <button class="shape-btn" data-shape="saturn">ğŸª åœŸæ˜Ÿ</button>
                <button class="shape-btn" data-shape="flower">ğŸŒ¸ èŠ±æœµ</button>
                <button class="shape-btn" data-shape="fireworks">ğŸ† çƒŸèŠ±</button>
            </div>
            
            <!-- å¤–éƒ¨æ¨¡å‹åŒºåŸŸï¼Œä¼šè‡ªåŠ¨å¡«å…… -->
            <label style="margin-top: 15px; display: none;" id="image-model-label">è‡ªå®šä¹‰æ¨¡å‹</label>
            <div class="shape-grid" id="image-model-container" style="display: none;">
            </div>
        </div>

        <div class="control-group">
            <label>ç²’å­é¢œè‰² (ä»…æ ‡å‡†å½¢çŠ¶æœ‰æ•ˆ)</label>
            <div class="color-grid" id="color-options-container">
            </div>
        </div>

        <div class="control-group">
            <label>æ‰‹åŠ¿è¯´æ˜</label>
            <div style="font-size: 12px; color: #888; line-height: 1.6;">
                ğŸ¤ <b>å•æŒ‡æåˆ</b>: ç¼©æ”¾æ§åˆ¶<br>
                ğŸ– <b>ç”¨åŠ›å¼ å¼€äº”æŒ‡</b>: <span style="color: white; font-weight: bold; text-shadow: 0 0 5px white;">æ¾æ•£æ¨¡å¼</span>
            </div>
        </div>
    </div>

    <script>
        // --- å…¨å±€å˜é‡é…ç½® ---
        const PRESET_COLORS = {
            'Elysia Pink': '#ff00cc',
            'Sky Blue': '#00bfff',
            'Mint Green': '#00ff7f',
            'Sun Gold': '#ffc300',
            'Pure White': '#ffffff',
            'Deep Purple': '#8a2be2'
        };
        const DEFAULT_COLOR_HEX = PRESET_COLORS['Elysia Pink'];
        const AUTO_ROTATION_SPEED = 0.001; 
    
        let scene, camera, renderer, particles;
        let geometry, material;
        
        // åŠ¨æ€çŠ¶æ€å˜é‡
        let currentParticleCount = 15000; 
        let usingImageColors = false; // æ˜¯å¦æ­£åœ¨ä½¿ç”¨å›¾ç‰‡è‡ªå¸¦çš„é¢œè‰²
        let currentShape = 'heart';
        let targetPositions = [];
        
        let handScale = 1.0; 
        let baseSize = 0.05;
        let isExploding = false;
        
        let userColor = new THREE.Color(DEFAULT_COLOR_HEX); 
        const explodeColor = new THREE.Color(0xffffff);
        let currentColor = new THREE.Color(DEFAULT_COLOR_HEX);
        
        // åˆå§‹åŒ–å¤–éƒ¨æ¨¡å‹å­˜å‚¨å¯¹è±¡ (é˜²æ­¢æœªå®šä¹‰æŠ¥é”™)
        window.IMAGE_MODELS = window.IMAGE_MODELS || {};
    
        // ğŸŒŸ æ ¸å¿ƒï¼šå½¢çŠ¶å®šä¹‰ (å·²ä¿®å¤å‚æ•°é—®é¢˜)
        const Shapes = {
            heart: (count) => {
                const arr = [];
                for(let i=0; i<count; i++) { 
                    let t = Math.random() * Math.PI * 2;
                    let r = Math.sqrt(Math.random()); 
                    let x = 16 * Math.pow(Math.sin(t), 3);
                    let y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                    let z = (Math.random() - 0.5) * 4 * r;
                    arr.push(x * r * 0.5, y * r * 0.5, z);
                }
                return arr;
            },
            saturn: (count) => {
                const arr = [];
                const sphereCount = Math.floor(count * 0.6);
                const ringCount = count - sphereCount;
                for(let i=0; i<sphereCount; i++) {
                    const phi = Math.acos( -1 + ( 2 * i ) / sphereCount );
                    const theta = Math.sqrt( sphereCount * Math.PI ) * phi;
                    const r = 6;
                    arr.push(r * Math.cos(theta) * Math.sin(phi), r * Math.sin(theta) * Math.sin(phi), r * Math.cos(phi));
                }
                for(let i=0; i<ringCount; i++) {
                    const theta = Math.random() * Math.PI * 2;
                    const r = 9 + Math.random() * 5; 
                    arr.push(r * Math.cos(theta), (Math.random()-0.5) * 0.5, r * Math.sin(theta));
                }
                return arr;
            },
            flower: (count) => {
                const arr = [];
                const k = 3; 
                for(let i=0; i<count; i++) { 
                    const theta = Math.random() * Math.PI * 2;
                    const r = Math.cos(k * theta) * 10;
                    const x = r * Math.cos(theta);
                    const y = r * Math.sin(theta);
                    const z = (Math.random() - 0.5) * 4 + Math.sin(r)*2;
                    arr.push(x, y, z);
                }
                return arr;
            },
            fireworks: (count) => {
                const arr = [];
                for(let i=0; i<count; i++) { 
                    const u = Math.random();
                    const v = Math.random();
                    const theta = 2 * Math.PI * u;
                    const phi = Math.acos(2 * v - 1);
                    const r = 5 + Math.random() * 10;
                    arr.push(r * Math.sin(phi) * Math.cos(theta), r * r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi));
                }
                return arr;
            },
            // è¯»å–å¤–éƒ¨å›¾ç‰‡æ¨¡å‹
            image: (modelKey) => {
                const model = window.IMAGE_MODELS[modelKey];
                if (model) {
                    return Array.from(model.positions); 
                }
                return Shapes.heart(currentParticleCount); 
            }
        };
    
        // ğŸŒŸ æ ¸å¿ƒï¼šåŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            const positions = particles.geometry.attributes.position.array;
            
            const moveSpeed = isExploding ? 0.06 : 0.05;
            particles.rotation.y += AUTO_ROTATION_SPEED;
            
            // --- é¢œè‰²é€»è¾‘ ---
            if (!usingImageColors) {
                // æ™®é€šæ¨¡å¼ï¼šä»£ç æ§åˆ¶é¢œè‰²å˜åŒ–
                if (isExploding) {
                    currentColor.lerp(explodeColor, 0.1);
                } else {
                    currentColor.lerp(userColor, 0.1);
                }
                material.color.set(currentColor);
            } else {
                // å›¾ç‰‡æ¨¡å¼ï¼šä¿æŒç™½è‰²åŸºç¡€ï¼Œè®©é¡¶ç‚¹é¢œè‰²ç”Ÿæ•ˆ
                material.color.setHex(0xffffff); 
            }
    
            // --- ä½ç½®é€»è¾‘ ---
            for (let i = 0; i < currentParticleCount; i++) { 
                const ix = i * 3;
                const iy = i * 3 + 1;
                const iz = i * 3 + 2;
    
                let tx, ty, tz;
    
                if (isExploding) {
                    const scatterRadius = 25; 
                    tx = Math.sin(i * 0.13) * scatterRadius + (Math.random() - 0.5) * 2;
                    ty = Math.cos(i * 0.17) * scatterRadius + (Math.random() - 0.5) * 2;
                    tz = Math.sin(i * 0.19) * scatterRadius + (Math.random() - 0.5) * 2;
                } else {
                    tx = targetPositions[ix] * handScale;
                    ty = targetPositions[iy] * handScale;
                    tz = targetPositions[iz] * handScale;
                }
    
                positions[ix] += (tx - positions[ix]) * moveSpeed;
                positions[iy] += (ty - positions[iy]) * moveSpeed;
                positions[iz] += (tz - positions[iz]) * moveSpeed;
            }
            
            particles.geometry.attributes.position.needsUpdate = true;
            
            const sizeFactor = isExploding ? 1.0 : (0.5 + handScale * 0.5);
            material.size = baseSize * sizeFactor * 5;
            
            renderer.render(scene, camera);
        }
        
        // ğŸŒŸ æ ¸å¿ƒï¼šæ›´æ–°å‡ ä½•ä½“ (ä¿®å¤äº†æè´¨æ— æ³•åˆ‡æ¢çš„ Bug)
        function updateGeometry(newCount, newPositions, newColors) {
            currentParticleCount = newCount;
            
            // 1. æ¸…ç†æ—§å¯¹è±¡
            if (particles) {
                scene.remove(particles);
                if (particles.geometry) particles.geometry.dispose();
                if (particles.material) particles.material.dispose();
            }
    
            // 2. å‡†å¤‡æ–°å‡ ä½•ä½“
            geometry = new THREE.BufferGeometry();
            let positionsArray;
            
            if (newPositions && newPositions.length === newCount * 3) {
                positionsArray = new Float32Array(newPositions);
            } else {
                positionsArray = new Float32Array(newCount * 3);
                for(let i=0; i<newCount*3; i++) {
                    positionsArray[i] = (Math.random() - 0.5) * 100; // éšæœºåˆå§‹ä½
                }
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positionsArray, 3));
            
            // 3. åˆ¤æ–­æ˜¯å¦ä½¿ç”¨é¡¶ç‚¹é¢œè‰²
            const useVertexColors = (newColors && newColors.length === newCount * 3);
            usingImageColors = useVertexColors;
    
            // 4. åˆ›å»ºæè´¨ (å…³é”®ä¿®å¤)
            const sprite = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/disc.png');
            material = new THREE.PointsMaterial({
                color: useVertexColors ? 0xffffff : userColor,
                size: baseSize * 5,
                map: sprite,
                sizeAttenuation: true,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                vertexColors: useVertexColors // æ ¹æ®æ•°æ®å†³å®šæ˜¯å¦å¼€å¯
            });
    
            if (useVertexColors) {
                geometry.setAttribute('color', new THREE.BufferAttribute(newColors, 3));
            }
            
            particles = new THREE.Points(geometry, material);
            scene.add(particles);
    
            // 5. è®¡ç®—ç›®æ ‡ä½ç½®
            if (currentShape.startsWith('image_')) {
                const modelKey = currentShape.substring(6);
                const model = window.IMAGE_MODELS[modelKey];
                if(model) targetPositions = model.positions; 
            } else if (currentShape in Shapes) {
                targetPositions = Shapes[currentShape](newCount);
            }
            
            console.log(`æ¨¡å‹æ›´æ–°å®Œæˆ: ${currentShape}, ç²’å­æ•°: ${newCount}, é¡¶ç‚¹è‰²: ${useVertexColors}`);
        }
        
        // ğŸŒŸ æ ¸å¿ƒï¼šæ¨¡å‹åˆ‡æ¢é€»è¾‘
        function switchModel(shapeKey) {
            console.log("æ­£åœ¨åˆ‡æ¢æ¨¡å‹:", shapeKey);
            document.querySelectorAll('.shape-btn, .image-btn').forEach(b => b.classList.remove('active'));
            
            let newCount;
            let newPositions = null;
            let newColors = null; 
            
            if (shapeKey.startsWith('image_')) {
                // å¤–éƒ¨å›¾ç‰‡æ¨¡å¼
                const modelKey = shapeKey.substring(6); 
                const model = window.IMAGE_MODELS[modelKey];
                if (model) {
                    newCount = model.count; 
                    newPositions = model.positions;
                    if (model.colors && model.colors.length > 0) {
                        newColors = model.colors;
                    }
                    currentShape = shapeKey;
                } else {
                    console.error('æœªæ‰¾åˆ°æ¨¡å‹æ•°æ®:', shapeKey);
                    return; 
                }
            } else {
                // å†…ç½®å½¢çŠ¶æ¨¡å¼
                newCount = 15000; 
                newPositions = null; // è§¦å‘éšæœºç”Ÿæˆ
                newColors = null;    // è§¦å‘å…³é—­é¡¶ç‚¹è‰²
                currentShape = shapeKey;
            }
            
            const newActiveButton = document.querySelector(`[data-shape="${shapeKey}"]`);
            if (newActiveButton) newActiveButton.classList.add('active');
    
            updateGeometry(newCount, newPositions, newColors);
        }
    
        // --- UI åŠ è½½ä¸äº¤äº’ ---
// --- UI åŠ è½½ä¸äº¤äº’ (ä¿®å¤ç‰ˆ) ---
function loadExternalModelsUI() {
        const uiPanel = document.getElementById('ui-panel');
        let label = uiPanel.querySelector('#image-model-label');
        let container = uiPanel.querySelector('#image-model-container');
        
        container.innerHTML = ''; 
        let hasExternalModels = false;

        // 1. åŠ è½½å¤–éƒ¨æ¨¡å‹æŒ‰é’®
        Object.entries(window.IMAGE_MODELS).forEach(([key, model]) => {
            hasExternalModels = true;
            const button = document.createElement('button');
            const shapeKey = 'image_' + key; 
            button.className = 'shape-btn image-btn'; // åŠ ä¸Š image-btn ç±»ä»¥ä¾¿åŒºåˆ†
            button.dataset.shape = shapeKey;
            button.innerText = model.name || key; 
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            button.addEventListener('click', () => switchModel(shapeKey));
            
            container.appendChild(button);
        });
        
        // æ˜¾ç¤º/éšè—å¤–éƒ¨æ¨¡å‹åŒºåŸŸ
        if (hasExternalModels) {
            label.style.display = 'block';
            container.style.display = 'grid';
        }
        
        // ğŸŒŸ 2. ç»‘å®šå†…ç½®æŒ‰é’® (è¿™é‡Œä¿®å¤äº†ä¹‹å‰çš„ Bug) ğŸŒŸ
        // é€»è¾‘æ”¹ä¸ºï¼šé€‰æ‹©æ‰€æœ‰ class æœ‰ 'shape-btn' ä½†æ²¡æœ‰ 'image-btn' çš„æŒ‰é’®
        const builtInButtons = document.querySelectorAll('.shape-btn:not(.image-btn)');
        
        builtInButtons.forEach(btn => {
            // å…ˆç§»é™¤æ—§äº‹ä»¶ï¼Œé˜²æ­¢é‡å¤
            if (btn._originalClickListener) {
                btn.removeEventListener('click', btn._originalClickListener); 
            }
            
            const listener = (e) => {
                // è·å– data-shape å±æ€§å¹¶åˆ‡æ¢
                const shape = e.target.getAttribute('data-shape');
                switchModel(shape);
            };
            
            btn.addEventListener('click', listener);
            btn._originalClickListener = listener; 
        });
        
        // 3. åˆå§‹é«˜äº®å½“å‰æŒ‰é’®
        const initialButton = document.querySelector(`[data-shape="${currentShape}"]`);
        if (initialButton) initialButton.classList.add('active');
    }
    
        // --- Three.js åˆå§‹åŒ– ---
        function initThree() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050505, 0.02);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 30;
    
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);
            
            // åˆå§‹åŠ è½½
            updateGeometry(15000, null, null);
            loadExternalModelsUI();
            
            window.addEventListener('resize', onWindowResize);
            animate(); 
        }
    
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    
        // --- MediaPipe æ‰‹åŠ¿è¯†åˆ« ---
        const videoElement = document.getElementsByClassName('input_video')[0];
        
        function onResults(results) {
            const loading = document.getElementById('loading');
            if(loading) loading.style.display = 'none';
            const statusDot = document.getElementById('status-dot');
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const wrist = landmarks[0];
    
                function isExtended(tipIdx, pipIdx) {
                    const tip = landmarks[tipIdx];
                    const pip = landmarks[tipIdx - 2]; 
                    const dTip = Math.hypot(tip.x - wrist.x, tip.y - wrist.y);
                    const dPip = Math.hypot(pip.x - wrist.x, pip.y - wrist.y);
                    return dTip > dPip * 1.25;
                }
    
                const thumbUp = isExtended(4, 2);
                const indexUp = isExtended(8, 6);
                const middleUp = isExtended(12, 10);
                const ringUp = isExtended(16, 14);
                const pinkyUp = isExtended(20, 18);
    
                const spreadDist = Math.hypot(landmarks[8].x - landmarks[20].x, landmarks[8].y - landmarks[20].y);
                const palmSize = Math.hypot(landmarks[0].x - landmarks[9].x, landmarks[0].y - landmarks[9].y);
                const isSpread = spreadDist > palmSize * 0.9;
    
                if (thumbUp && indexUp && middleUp && ringUp && pinkyUp && isSpread) {
                    isExploding = true;
                    statusDot.className = 'status-dot active exploding';
                    handScale = 1.1; 
                } else {
                    isExploding = false;
                    statusDot.className = 'status-dot active';
                    const thumbTip = landmarks[4];
                    const indexTip = landmarks[8];
                    const distance = Math.hypot(thumbTip.x - indexTip.x, thumbTip.y - indexTip.y);
                    const normalized = Math.max(0, Math.min(1, (distance - 0.02) / 0.18)); 
                    const targetScale = 0.5 + normalized * 2.0;
                    handScale += (targetScale - handScale) * 0.1;
                }
            } else {
                statusDot.className = 'status-dot';
                isExploding = false;
                handScale += (1.0 - handScale) * 0.05;
            }
        }
    
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        hands.onResults(onResults);
    
        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => await hands.send({image: videoElement}),
            width: 320,
            height: 240
        });
        cameraUtils.start();
    
        // --- é¢œè‰²ä¸æŒ‰é’®äº¤äº’ ---
        const colorContainer = document.getElementById('color-options-container');
        Object.entries(PRESET_COLORS).forEach(([name, hex]) => {
            const div = document.createElement('div');
            div.className = 'color-option';
            div.style.backgroundColor = hex;
            div.title = name;
            div.setAttribute('data-color', hex);
            if (hex === DEFAULT_COLOR_HEX) div.classList.add('active');
            div.addEventListener('click', () => {
                document.querySelectorAll('.color-option').forEach(c => c.classList.remove('active'));
                div.classList.add('active');
                userColor.set(hex); 
                document.documentElement.style.setProperty('--primary-color', hex);
            });
            colorContainer.appendChild(div);
        });
        
        document.getElementById('fullscreen-btn').addEventListener('click', () => {
            if (!document.fullscreenElement) document.body.requestFullscreen().catch(err => alert(`æ— æ³•è¿›å…¥å…¨å±: ${err.message}`));
            else document.exitFullscreen();
        });
    
        const toggleUiBtn = document.getElementById('toggle-ui-btn');
        toggleUiBtn.addEventListener('click', () => {
            const isHidden = document.getElementById('ui-panel').classList.toggle('hidden');
            toggleUiBtn.innerText = isHidden ? 'â•' : 'â–';
        });
    
        initThree();
    </script>
</body>
</html>